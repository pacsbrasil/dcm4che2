<project>
  <!-- Must have a version for every POM file release - although it
   can just set default versions that apply to anything not otherwise
   versioned.
   -->
  <!-- These properties can be over-ridden in build.properties to enable
       a build to succeed.
  -->
  <property name="mvn" value="mvn.bat" />
  <property name="svn" value="svn" />
  <property name="bc" value="bc" />

  <!-- Inherit from the parent the version information, if any -->
  <property name="version.parent.base" value="1.0" />

  <property name="version.base" value="${version.parent.base}" />
  <property name="version.increment" value="${version.parent.increment}" />

  <!-- Compound properties -->
  <property name="version.version" value="${version.base}.${version.increment}" />
  <propertyset id="childProperties">
     <propertyref prefix="version.parent" />
     <propertyref name="version.releaseProperties" />
     <propertyref name="version.svnexternals" />
  </propertyset>

  <target name="install" description="Perform a Maven Install">
     <exec executable="${mvn}" failonerror="true">
        <arg line="install" />
     </exec>
  </target>

  <target name="deploy" description="Perfrom a Maven Deploy">
     <exec executable="${mvn}" failonerror="true">
        <arg line="deploy:deploy" />
     </exec>
  </target>

  <target name="clean" description="Perfrom a Maven Clean">
     <exec executable="${mvn}" failonerror="true">
        <arg line="clean" />
     </exec>
  </target>

  <!-- Recursively calls "childCall" on all child elements -->
  <target name="recurseChildrenAll">
  </target>

  <target name="recurseChildren">
     <antcall target="recurseChildrenAll" inheritAll="false">
        <param name="version.parent.base" value="${version.base}" />
        <param name="version.parent.increment" value="${version.increment}" />
        <param name="childCall" value="${childCall}" />
        <param name="version.releaseProperties" value="../${version.releaseProperties}" />
        <param name="version.svnexternals" value="../${version.svnexternals}" />
     </antcall>
  </target>

  <target name="echoVersion" description="Echo all the project names/versions.">
     <echo message="The version of ${ant.project.name} is ${version.version}" />
     <antcall target="recurseChildren">
        <param name="childCall" value="echoVersion" />
     </antcall>
  </target>

  <target name="nextVersion" description="Figure out, and set the 'next' version.">
     <script language="JavaScript">
        project.setProperty("version.next",""+(1+parseInt(project.getProperty("version.increment"))));
     </script>
     <echo message="The next version of ${ant.project.name} is ${version.base}.${version.next}" />
     <replace file="build.xml" 
        token="&lt;property name=&quot;version.increment&quot; value=&quot;${version.increment}&quot; />" 
        value="&lt;property name=&quot;version.increment&quot; value=&quot;${version.next}&quot; />" 
     />
  </target>

  <!-- Erase the release properties if this is being run at the top level -->
  <target name="intializeReleaseProperties" unless="version.releaseProperties">     
     <delete file="release.properties" quiet="true"/>
     <property name="version.releaseProperties" value="release.properties" />
  </target>


  <target name="updatePomRelease" description="Update the pom file versions to the next release version" depends="intializeReleaseProperties">
     <echo>Update Pom Relase on ${ant.project.name} to version ${version.version}</echo>
     <echo file="${version.releaseProperties}" append="true">
        versions.${ant.project.name}=${version.version}
     </echo>
     <property file="${version.releaseProperties}" />
     <script language="JavaScript"><![CDATA[
        var fr = new java.io.FileReader(basedir+"/pom.xml");
        var inp = new java.io.LineNumberReader(fr);
        var fw = new java.io.FileWriter(basedir+"/pom.xml.tmp");
        var outp = new java.io.PrintWriter(fw);
        var line = inp.readLine();
        var inModule = false;

        var pos;
        while(line!=null) {
          if( inModule ) {
            pos = line.indexOf("<version>");
            if( pos>=0 ) {
               pos2 = line.indexOf("</version>");
               if( pos2==-1 ) throw "Version line for "+inModule+" on line "+inp.getLineNumber()+" does not contain end version.";
               var versionName = new java.lang.String("versions."+inModule);
               var newVersion = project.getProperty(versionName);
               if( newVersion!=null ) {
                  java.lang.System.out.println("Found a version "+newVersion+" for "+versionName);
                  line = line.substring(0,pos+9) + newVersion+ line.substring(pos2);
               } else {
                  pos = line.indexOf("SNAPSHOT");
                  if( pos>0 ) throw "SNAPSHOT Version of "+inModule+" is being used in "+project.getProperty("ant.project.name");
               }
               inModule = false;
            }
          } 

          pos = line.indexOf("<artifactId>");
          if( pos>=0 ) {
             pos2 = line.indexOf("</artifactId>");
             if( pos2==-1 ) throw "artifactId at line "+inp.getLineNumber()+" doesn't have XML ending.";
             inModule = line.substring(pos+12,pos2);
             java.lang.System.out.println("Found artifactId - looking for version for "+inModule);
          }
          outp.println(line);
          line = inp.readLine();
        };
        inp.close();
        outp.close();
     ]]> </script>
     <antcall target="recurseChildren">
       <param name="childCall" value="updatePomRelease" />
     </antcall>
     <move file="pom.xml" tofile="pom.xml~" />
     <move file="pom.xml.tmp" tofile="pom.xml" />
  </target>

  <target name="revertPomDevelop" description="Revert the POM file back to the development version.">
     <exec executable="${svn}" failonerror="true">
        <arg line="revert pom.xml" />
     </exec>
     <antcall target="recurseChildren">
        <param name="childCall" value="revertPomDevelop" />
     </antcall>
  </target>

  <!-- Copies the contents of the current directory to
     the named directory location.
     -->
  <target name="copyToTag" if="version.tags">
     <exec executable="${svn}" failonerror="true">
        <arg line="copy . ${version.tags}/${ant.project.name}-${version.version} -m 'Releasing version ${version.version}' --non-interactive" />
     </exec>
  </target>


  <target name="createSvnExternalsChildTags" if="version.tags">
     <echo file="${version.svnexternals}" append="true">${ant.project.name} ${version.tags}/${ant.project.name}-${version.version}
     </echo>
  </target>

  <target name="createSvnExternalsChild" unless="toplevel">
     <antcall target="createSvnExternalsChildTags" />
  </target>

  <target name="createSvnExternalsTop" if="toplevel">
      <delete file="svn.externals"/>
      <property name="version.svnexternals" value="svn.externals" />
  </target>

  <target name="createSvnExternals" depends="createSvnExternalsTop, createSvnExternalsChild">
     <antcall target="recurseChildren">
        <param name="childCall" value="createSvnExternals" />
     </antcall>
  </target>

  <target name="commitReleaseProperties" if="toplevel">
     <exec executable="${svn}" failonerror="true">
        <arg line="commit release.properties build.xml --non-interactive -m 'Update the release.properties file.'" />
     </exec>

     <delete dir="${ant.project.name}" quiet="true"/>
     <exec executable="${svn}" failonerror="true">
        <arg line="checkout ${version.tags}/${ant.project.name}-${version.version} ${ant.project.name} --depth immediates" />
     </exec>
     <exec executable="${svn}" failonerror="true">
        <arg line="propset svn:externals -F ${version.svnexternals} ${ant.project.name} --non-interactive" />
     </exec>
     <exec executable="${svn}" failonerror="true">
        <arg line="commit ${ant.project.name} --non-interactive -m 'Commit the svn:externals property on the tagged version.'" />
     </exec>
     <delete dir="${ant.project.name}" />
     <delete file="svn.externals" />
  </target>

  <target name="releaseCommit" depends="copyToTag, createSvnExternals, commitReleaseProperties">
     <!-- Recursively enumerate over the child directories calling release commit. -->
     <antcall target="recurseChildren">
        <param name="childCall" value="releaseCommit" />
     </antcall>
  </target>

  <target name="prepareRelease" depends="clean,updatePomRelease,install,nextVersion,releaseCommit" />

  <target name="releaseDeploy" depends="deploy,revertPomDevelop" />

  <target name="release" depends="prepareRelease,releaseDeploy" description="Release the overall project."/>

</project>
