<project name="dcm4che-xero" default="deploy">
  <!-- Include build.properties first as it over-rides default.properties -->
  <property file="build.properties" />
  <property file="build.properties.default" />

  <target name="build" description="Deploy Xero to the development Dcm4che server.">
     <exec executable="${mvn}">
        <arg line="install" />
     </exec>
  </target>

  <!-- Sets up the lib directory -->
  <target name="setupLib">
     <delete>
        <fileset dir="${developmentServer}/server/default/lib">
           <include name="jaxb*.jar" />
        </fileset>
        <fileset dir="${developmentServer}/server/default/deploy/jbossws.sar">
           <include name="jaxb*.jar" />
        </fileset>
     </delete>
     <copy todir="${developmentServer}/server/default/lib">
        <fileset dir="xero-ear/target/xero" includes="jaxb*.jar" />
     </copy>
  </target>

  <!-- Copies just the webapp files over for a quick test deploy -->
  <target name="deployWebapp" description="Copy webapp files over for a no-redeploy test.">
     <copy todir="${developmentServer}/server/default/deploy/xero.ear/xero.war">
        <fileset dir="xero-war/src/main/webapp" includes="**/*" />
     </copy>
  </target>

  <target name="setupConf">
     <copy todir="${developmentServer}/server/default/conf" overwrite="true">
        <fileset dir="conf" includes="**/*" />
     </copy>
  </target>

  <target name="setup" description="Setup the development server from the JBoss base server." depends="deploy, setupLib, setupConf, setupDefaultUrl">
  </target>

  <!-- Adds default.htm and index.html to the wado war file -->
  <target name="setupDefaultUrl">
     <jar destfile="${developmentServer}/server/default/deploy/dcm4chee-wado.war" update="true">
        <fileset dir="xero-war/src/main/webapp" includes="default.htm,index.html" />
     </jar>
  </target>

  <target name="deploy" depends="build,deployXero" description="Deploy Xero to the development Dcm4che server." />

  <target name="deployXero">
     <copy todir="${developmentServer}/server/default/deploy/xero.ear" preservelastmodified="true">
        <fileset dir="xero-ear/target/xero" excludes="xero.war,xero-wado.war,view-xero.war" />
     </copy>
     <copy todir="${developmentServer}/server/default/deploy/xero.ear/xero.war" preservelastmodified="true">
        <fileset dir="xero-war/target/xero" />
     </copy>
     <copy todir="${developmentServer}/server/default/deploy/xero.ear/xero-wado.war" preservelastmodified="true">
        <fileset dir="xero-wado-war/target/xero-wado" excludes="**/*.jar" />
     </copy>
     <copy todir="${developmentServer}/server/default/deploy/xero.ear/view-xero.war" preservelastmodified="true">
        <fileset dir="view-xero/target/view-xero" excludes="**/*.jar" />
     </copy>
   </target>

   <target name="deployView">
      <copy todir="${developmentServer}/server/default/deploy/xero.ear/view-xero.war">
         <fileset dir="view-xero/src/main/webapp" includes="**/*" />
      </copy>
      <copy todir="${developmentServer}/server/default/deploy/xero.ear/view-xero.war/WEB-INF/classes">
         <fileset dir="view-xero/src/main/resources" includes="**/*" />
      </copy>
   </target>

   <target name="deployWado" depends="build">
     <copy todir="${developmentServer}/server/default/deploy/xero-wado-war.war" preservelastmodified="true">
        <fileset dir="xero-wado-war/target/xero-wado-war" includes="**/*" />
     </copy>
  </target>

  <target name="package" depends="build, copyPackage" description="Create a JAR file containing all the required files for Xero.  Depends on stable, so you must setup a directory to contain the stable build.">
     <mkdir dir="target" />
     <zip destfile="target/xero.zip" basedir="${stableServer}" />
  </target>

  <target name="copyPackage">
     <mkdir dir="${stableServer}" />
     <copy todir="${stableServer}/server/default/deploy/xero.ear" preservelastmodified="true">
        <fileset dir="xero-ear/target/xero" excludes="xero.war,xero-wado.war" />
     </copy>
     <copy todir="${stableServer}/server/default/deploy/xero.ear/xero-wado.war" preservelastmodified="true">
        <fileset dir="xero-wado-war/target/xero-wado" excludes="xero-wado.war,**/*.jar" />
     </copy>
     <copy todir="${stableServer}/server/default/deploy/xero.ear/xero.war" preservelastmodified="true">
        <fileset dir="xero-war/target/xero" excludes="xero.war" />
        <fileset dir="xero-ipod/src/main/webapp">
          <include name="**/*" />
        </fileset>
     </copy>
     <copy todir="${stableServer}/server/default/conf">
        <fileset dir="conf" includes="**/*" />
     </copy>
     <copy tofile="${stableServer}/server/default/lib/jaxb-api.jar" file="xero-ear/target/xero/jaxb-api-2.0.jar" />
     <copy tofile="${stableServer}/server/default/lib/jaxb-impl.jar" file="xero-ear/target/xero/jaxb-impl-2.0.jar" />
  </target> 

</project>
