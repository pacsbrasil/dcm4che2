<x:xsl
  pageConfig="#{(pageConfig!=null ? pageConfig : metadata.image.imageXsl).menuGspsXsl}"
  xmlns:x="http://www.dcm4che.org/xero/jsf"
  xmlns:ui="http://java.sun.com/jsf/facelets"
  xmlns:xsl="http://www.w3.org/1999/XSL/Transform"
  xmlns:m="http://www.dcm4che.org/xero/metadata/image/imageXsl/menuGspsXsl"
  xmlns:c="http://java.sun.com/jstl/core"
  xmlns="http://www.w3.org/1999/xhtml"
  xmlns:h="http://www.w3.org/1999/xhtml"
  m:includeXsl="/image/menuGspsXsl.xhtml"
>
<!-- Displays the current GSPS being applied - must be under an se:study -->
<x:template name="currentGsps" mode="newlayout" match="h:span[@class='currentGsps']">
  <xsl:param name="node" select="/.."/>
  <xsl:param name="custNode" select="/.." />
  <xsl:param name="gspsLabel"><xsl:choose><xsl:when test="$custNode/@gspsLabel"><xsl:value-of select="$custNode/@gspsLabel" /></xsl:when><xsl:when test="$node/@gspsLabel"><xsl:value-of select="$node/@gspsLabel" /></xsl:when></xsl:choose></xsl:param>
  <xsl:value-of select="$gspsLabel" />
</x:template>

<!-- Iterate over all GSPS nodes with distinct names. -->
<x:template name="gspsLayout" mode="newlayout" match="se:gsps">
 <xsl:param name="loc" />
 <xsl:param name="node" select="/.."/>
 <xsl:param name="custNode" select="/.." />
 <xsl:variable name="children" select="./*" />
 <xsl:for-each select="$node/se:series/se:gsps">
   <xsl:variable name="name" select="@contentLabel" />
   <xsl:variable name="curSOP" select="@SOPInstanceUID" />
   <xsl:variable name="firstSOP" select="($node/se:series/se:gsps[@contentLabel=$name]/@SOPInstanceUID)[1]" />
   <xsl:if test="$firstSOP = $curSOP" >
     <xsl:apply-templates mode="newlayout" select="$children">
       <xsl:with-param name="loc" />
       <xsl:with-param name="node" select="." />
       <xsl:with-param name="custNode" select="$custNode" />
     </xsl:apply-templates>
   </xsl:if>
 </xsl:for-each>
</x:template>

<x:template name="gspsLabel" mode="newlayout" match="h:span[@class='gspsLabel']">
  <xsl:param name="node" select="/.."/>
  <xsl:message>GSPS Label for <xsl:value-of select="$node/@gspsLabel" /></xsl:message>
  <xsl:value-of select="$node/@contentLabel" />
</x:template>

<x:template name="gspsHrefArgs" mode="hrefArgsNode" match="se:gsps"><xsl:apply-templates select=".." mode="hrefArgsNode" />&amp;gsps=<xsl:value-of select="@contentLabel" /></x:template>

</x:xsl>