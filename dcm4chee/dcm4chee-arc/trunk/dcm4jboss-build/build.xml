<project name="dcm4jboss-build" default="dist">
  <!-- Allow override from local properties file -->
  <property file="build.properties"/>
  <property file="../build.properties"/>
  <property name="version" value="2.12.0"/>
  <property name="arr-version" value="3.0.3"/>
  <property name="audit-version" value="2.12.0"/>
  <property name="dist.jboss.conf" value="default"/>
  <property name="target.dir" value="${basedir}/target"/>
  <!-- Override with your dcm4chee-arr 3.x location -->
  <property name="dcm4chee-arr.home" value="${user.home}/dcm4chee/dcm4chee-arr"/>
  <property name="dcm4chee-arr.entities" value="${dcm4chee-arr.home}/dcm4chee-arr-entities"/>
  <property name="dcm4chee-arr.ear" value="${dcm4chee-arr.home}/dcm4chee-arr-ear"/>
  <!-- Override with your dcm4chee-audit 3.x location -->
  <property name="dcm4chee-audit.home" value="${user.home}/dcm4chee/dcm4chee-audit"/>
  <property name="dcm4chee-audit.login" value="${dcm4chee-audit.home}/dcm4chee-audit-login"/>
  <property name="dcm4chee-audit.logger" value="${dcm4chee-audit.home}/dcm4chee-audit-logger"/>
  <!-- Override with your FOP dist location -->
  <property name="fop.home" value="${user.home}/fop-0.20.5"/>
  <target name="clean">
    <delete dir="${target.dir}"/>
    <ant inheritAll="false" dir="../dcm4che14" target="clean"/>
    <ant inheritAll="false" dir="../dcm4jboss-ejb" target="clean"/>
    <ant inheritAll="false" dir="../dcm4jboss-sar" target="clean"/>
    <ant inheritAll="false" dir="../dcm4jboss-hl7" target="clean"/>
    <ant inheritAll="false" dir="../dcm4jboss-wado" target="clean"/>
    <ant inheritAll="false" dir="../dcm4jboss-web" target="clean"/>
    <ant inheritAll="false" dir="../dcm4jboss-xds" target="clean"/>
    <ant inheritAll="false" dir="../dcm4jboss-xds-consumer" target="clean"/>
    <ant inheritAll="false" dir="../dcm4jboss-arr" target="clean"/>
    <ant inheritAll="false" dir="../dcm4jboss-cdw" target="clean"/>
  </target>
  <target name="jar">
    <ant inheritAll="false" dir="../dcm4che14" target="jar"/>
    <ant inheritAll="false" dir="../dcm4jboss-ejb" target="jar"/>
    <ant inheritAll="false" dir="../dcm4jboss-sar" target="jar"/>
    <ant inheritAll="false" dir="../dcm4jboss-hl7" target="jar"/>
    <ant inheritAll="false" dir="../dcm4jboss-wado" target="jar"/>
    <ant inheritAll="false" dir="../dcm4jboss-wado" target="war"/>
    <ant inheritAll="false" dir="../dcm4jboss-web" target="war">
		  <property name="version" value="${version}" />
	  </ant>
    <ant inheritAll="false" dir="../dcm4jboss-xds" target="jar"/>
    <ant inheritAll="false" dir="../dcm4jboss-xds" target="war"/>
    <ant inheritAll="false" dir="../dcm4jboss-xds-consumer" target="sar"/>
    <ant inheritAll="false" dir="../dcm4jboss-arr" target="jar"/>
    <ant inheritAll="false" dir="../dcm4jboss-arr" target="war"/>
    <ant inheritAll="false" dir="../dcm4jboss-cdw" target="jar"/>
    <ant inheritAll="false" dir="../dcm4jboss-cdw" target="sar"/>
  </target>
	
  <target name="fixcrlf">
    <mkdir dir="${target.dir}/bin"/>
  	<fixcrlf srcdir="../dcm4jboss-sar/src/etc/bin" includes="*.sh,*.conf"
  		destdir="${target.dir}/bin" eol="lf"/>
  	<fixcrlf srcdir="../dcm4jboss-sar/src/etc/bin" includes="*.bat"
  		destdir="${target.dir}/bin" eol="crlf"/>
  	<fixcrlf srcdir="bin" includes="*.sh"
  		destdir="${target.dir}/bin" eol="lf"/>
  	<fixcrlf srcdir="bin" includes="*.bat"
  		destdir="${target.dir}/bin" eol="crlf"/>
    <mkdir dir="${target.dir}/doc/licenses"/>
  	<fixcrlf srcdir="../dcm4che14/doc/licenses"
  		destdir="${target.dir}/doc/licenses" eol="crlf"/>
  	<fixcrlf srcdir="../dcm4jboss-sar/doc" includes="INSTALL, PWD2HASH"
  		destdir="${target.dir}/doc" eol="crlf" />
  </target>
  
  <target name="dist" depends="hsql-dist,psql-dist,mysql-dist,mssql-dist,oracle-dist,db2-dist"/>
  
  <target name="hsql-dist" depends="jar,fixcrlf">
    <antcall target="db-dist">
      <param name="db.name" value="hsql"/>
    </antcall>
  </target>
  <target name="psql-dist" depends="jar,fixcrlf">
    <antcall target="db-dist">
      <param name="db.name" value="psql"/>
    </antcall>
  </target>
  <target name="mysql-dist" depends="jar,fixcrlf">
    <antcall target="db-dist">
      <param name="db.name" value="mysql"/>
    </antcall>
  </target>
  <target name="oracle-dist" depends="jar,fixcrlf">
    <antcall target="db-dist">
      <param name="db.name" value="oracle"/>
    </antcall>
  </target>
  <target name="db2-dist" depends="jar,fixcrlf">
    <antcall target="db-dist">
      <param name="db.name" value="db2"/>
    </antcall>
  </target>
  <target name="mssql-dist" depends="jar,fixcrlf">
    <antcall target="db-dist">
      <param name="db.name" value="mssql"/>
    </antcall>
  </target>

  <target name="db-dist">
    <property name="dist.db" value="dcm4chee-${db.name}-${version}"/>
    <property name="dist.db.config" value="${dist.db}/server/default"/>
    <zip destfile="${target.dir}/${dist.db}.zip">
      <zipfileset dir="../dcm4che14/build" prefix="${dist.db.config}">
        <include name="lib/dcm4che.jar"/>
      </zipfileset>
      <zipfileset dir="../dcm4che14" prefix="${dist.db.config}">
        <include name="lib/dcm4che-imageio-rle-2.0.4.jar"/>
        <include name="lib/jai_imageio.jar"/>
        <include name="lib/clibwrapper_jiio.jar"/>
      </zipfileset>
      <zipfileset dir="../dcm4che14" prefix="${dist.db}">
        <include name="bin/libclib_jiio.so"/>
        <include name="bin/clib_jiio*.dll"/>
      </zipfileset>
      <zipfileset dir="../dcm4jboss-ejb/target/common" prefix="${dist.db.config}">
        <include name="lib/*"/>
      </zipfileset>
      <zipfileset dir="../dcm4jboss-ejb/target/common" prefix="${dist.db}">
        <include name="bin/*"/>
      </zipfileset>
      <zipfileset dir="../dcm4jboss-ejb/test/data" prefix="${dist.db}/bin"/>
      <zipfileset dir="../dcm4jboss-ejb/target/${db.name}" prefix="${dist.db.config}">
        <include name="lib/*"/>
        <include name="deploy/*"/>
      </zipfileset>
      <zipfileset dir="../dcm4jboss-ejb/src/etc/common" prefix="${dist.db.config}">
        <include name="conf/*"/>
        <include name="deploy/**"/>
      </zipfileset>
      <zipfileset dir="../dcm4jboss-ejb/src/etc/${db.name}" prefix="${dist.db.config}">
        <include name="conf/*"/>
        <include name="deploy/**"/>
        <include name="data/**"/>
        <include name="lib/*"/>
      </zipfileset>
      <zipfileset dir="../dcm4jboss-ejb/src/etc/${db.name}" prefix="${dist.db}">
        <include name="sql/*"/>
      </zipfileset>
        <zipfileset dir="../dcm4jboss-sar/target" prefix="${dist.db.config}">
          <include name="lib/*"/>
        </zipfileset>
        <zipfileset dir="../dcm4jboss-sar/target" prefix="${dist.db}">
          <include name="bin/*"/>
        </zipfileset>
      <zipfileset dir="../dcm4jboss-sar" prefix="${dist.db}">
        <include name="bin/JavaService.exe"/>
      </zipfileset>
      <zipfileset dir="../dcm4jboss-sar" prefix="${dist.db.config}">
        <include name="lib/commons-compress-20050911.jar"/>
        <include name="lib/dcm4che-audit-2.0.11.jar"/>
      </zipfileset>
      <zipfileset dir="../dcm4jboss-sar/src/etc" prefix="${dist.db.config}">
        <include name="conf/**"/>
        <include name="deploy/**"/>
      </zipfileset>
      <zipfileset dir="${target.dir}" prefix="${dist.db}">
        <include name="bin/*"/>
      	<exclude name="bin/*.sh"/>
      	<exclude name="bin/uninstall-dcm4chee-arr-old.bat"/>
      	<exclude name="bin/uninstall-dcm4chee-auditlog-old.bat"/>
        <include name="doc/**"/>
      </zipfileset>
      <zipfileset dir="${target.dir}" prefix="${dist.db}" filemode="755">
        <include name="bin/*.sh"/>
       	<exclude name="bin/uninstall-dcm4chee-arr-old.sh"/>
       	<exclude name="bin/uninstall-dcm4chee-auditlog-old.sh"/>
      </zipfileset>
      <zipfileset dir="../dcm4jboss-hl7" prefix="${dist.db.config}">
        <include name="lib/xhl7.jar"/>
      </zipfileset>
      <zipfileset dir="../dcm4jboss-hl7/target" prefix="${dist.db.config}">
        <include name="lib/*"/>
      </zipfileset>
      <zipfileset dir="../dcm4jboss-hl7/src/etc" prefix="${dist.db.config}">
        <include name="conf/**"/>
        <include name="deploy/**"/>
      </zipfileset>
      <zipfileset dir="../dcm4jboss-wado/target" prefix="${dist.db.config}">
        <include name="lib/*"/>
        <include name="deploy/*"/>
      </zipfileset>
      <zipfileset dir="../dcm4jboss-wado/src/etc" prefix="${dist.db.config}">
        <include name="conf/**"/>
        <include name="deploy/**"/>
      </zipfileset>
      <zipfileset dir="../dcm4jboss-web/target" prefix="${dist.db.config}">
        <include name="deploy/*"/>
      </zipfileset>
      <zipfileset dir="../dcm4jboss-web/src/etc" prefix="${dist.db.config}">
        <include name="conf/**"/>
      </zipfileset>
      <zipfileset dir="../dcm4jboss-xds/target" prefix="${dist.db.config}">
        <include name="lib/*"/>
        <include name="deploy/*"/>
      </zipfileset>
      <zipfileset dir="../dcm4jboss-xds/src/etc" prefix="${dist.db.config}">
        <include name="conf/**"/>
        <include name="deploy/**"/>
      </zipfileset>
      <zipfileset dir="../dcm4jboss-xds-consumer/target" prefix="${dist.db.config}">
        <include name="deploy/*"/>
      </zipfileset>
      <zipfileset dir="../dcm4jboss-xds-consumer" prefix="${dist.db.config}">
        <include name="lib/FastInfoset.jar"/>
        <include name="lib/jaxb-api.jar"/>
        <include name="lib/jaxb-impl.jar"/>
        <include name="lib/jaxb-libs.jar"/>
        <include name="lib/jaxr-api.jar"/>
        <include name="lib/jaxr-ebxml.jar"/>
        <include name="lib/omar-common.jar"/>
        <include name="lib/oasis-regrep.jar"/>
        <include name="lib/relaxngDatatype.jar"/>
        <include name="lib/xsdlib.jar"/>
      </zipfileset>
      <zipfileset dir="../dcm4jboss-arr/target/common" prefix="${dist.db.config}">
        <include name="lib/*"/>
        <include name="deploy/*"/>
      </zipfileset>
      <zipfileset dir="../dcm4jboss-arr/target/${db.name}" prefix="${dist.db.config}">
        <include name="lib/*"/>
        <include name="deploy/*"/>
      </zipfileset>
      <zipfileset dir="../dcm4jboss-arr/src/etc" prefix="${dist.db.config}">
        <include name="conf/**"/>
        <exclude name="conf/standardjboss.xml"/>
        <exclude name="conf/standardjbosscmp-jdbc.xml"/>
        <include name="deploy/**"/>
      </zipfileset>
      <zipfileset dir="../dcm4jboss-cdw/target" prefix="${dist.db.config}">
        <include name="lib/*"/>
        <include name="deploy/*"/>
      </zipfileset>
      <zipfileset dir="../dcm4jboss-cdw/src/etc" prefix="${dist.db.config}">
        <include name="conf/dcm4chee-cdw/*"/>
        <include name="conf/xmdesc/*"/>
        <include name="data/**"/>
      </zipfileset>
      <zipfileset dir="${fop.home}/build" prefix="${dist.db.config}/lib">
        <include name="fop.jar"/>
      </zipfileset>
      <zipfileset dir="${fop.home}" prefix="${dist.db.config}">
        <include name="lib/avalon-framework-cvs-20020806.jar"/>
        <include name="lib/batik.jar"/>
      </zipfileset>
    </zip>
  </target>
	
  <target name="dist-arr"
  	depends="opt-arr-hsql,opt-arr-psql,opt-arr-mysql,opt-arr-mssql,opt-arr-oracle,opt-arr-db2"/>
  <target name="opt-arr-hsql">
    <antcall target="opt-arr">
      <param name="db.name" value="hsql"/>
    </antcall>
  </target>
  <target name="opt-arr-mysql">
    <antcall target="opt-arr">
      <param name="db.name" value="mysql"/>
    </antcall>
  </target>
  <target name="opt-arr-mssql">
    <antcall target="opt-arr">
      <param name="db.name" value="mssql"/>
    </antcall>
  </target>
  <target name="opt-arr-psql">
    <antcall target="opt-arr">
      <param name="db.name" value="psql"/>
    </antcall>
  </target>
  <target name="opt-arr-oracle">
    <antcall target="opt-arr">
      <param name="db.name" value="oracle"/>
    </antcall>
  </target>
  <target name="opt-arr-db2">
    <antcall target="opt-arr">
      <param name="db.name" value="db2"/>
    </antcall>
  </target>
  <target name="opt-arr" depends="fixcrlf">  	
    <property name="dist.db.config" value="server/default"/>
    <zip destfile="${target.dir}/upgrade-dcm4chee-arr-${db.name}-${arr-version}.zip">
	  <zipfileset dir="${jboss.server.home}" prefix="${dist.db.config}">
	    <include name="deploy/ejb3.deployer/**"/>
	  	<include name="deploy/jboss-aop-jdk50.deployer/**"/>
	  	<include name="deploy/jbossws.sar/**"/>
	  	<include name="deploy/ear-deployer.xml"/>
	  	<include name="deploy/ejb3-interceptors-aop.xml"/>
	  	<!--include name="deploy/usertx-service.xml"/-->
	  	<include name="lib/antlr-2.7.6.jar"/>
	  	<include name="lib/cglib.jar"/>
	  	<include name="lib/ejb3-persistence.jar"/>
	  	<include name="lib/hibernate-annotations.jar"/>
	  	<include name="lib/hibernate-entitymanager.jar"/>
	  	<include name="lib/hibernate3.jar"/>
	  	<include name="lib/javassist.jar"/>
	  </zipfileset>
      <zipfileset dir="${dcm4chee-arr.ear}/target" prefix="${dist.db.config}/deploy">
        <include name="dcm4chee-arr-${db.name}-*.ear"/>
      </zipfileset>
      <zipfileset dir="${dcm4chee-arr.entities}/target/hibernate3/sql" prefix="sql">
        <include name="dcm4chee-arr-${db.name}.ddl"/>
      </zipfileset>      
      <zipfileset dir="${target.dir}" filemode="755">
    	<include name="bin/uninstall-dcm4chee-arr-old.sh"/>
      </zipfileset>
      <zipfileset dir="${target.dir}">
      	<include name="bin/uninstall-dcm4chee-arr-old.bat"/>
      </zipfileset>
    </zip>  	     
  </target>		

	
  <target name="dist-auditlog"
  	depends="opt-auditlog-hsql,opt-auditlog-psql,opt-auditlog-mysql,opt-auditlog-mssql,opt-auditlog-oracle,opt-auditlog-db2"/>
  <target name="opt-auditlog-hsql">
    <antcall target="opt-auditlog">
      <param name="db.name" value="hsql"/>
    </antcall>
  </target>
  <target name="opt-auditlog-mysql">
    <antcall target="opt-auditlog">
      <param name="db.name" value="mysql"/>
    </antcall>
  </target>
  <target name="opt-auditlog-mssql">
    <antcall target="opt-auditlog">
      <param name="db.name" value="mssql"/>
    </antcall>
  </target>
  <target name="opt-auditlog-psql">
    <antcall target="opt-auditlog">
      <param name="db.name" value="psql"/>
    </antcall>
  </target>
  <target name="opt-auditlog-oracle">
    <antcall target="opt-auditlog">
      <param name="db.name" value="oracle"/>
    </antcall>
  </target>
  <target name="opt-auditlog-db2">
    <antcall target="opt-auditlog">
      <param name="db.name" value="db2"/>
    </antcall>
  </target>
  <target name="opt-auditlog" depends="fixcrlf">  	
    <property name="dist.db.config" value="server/default"/>
    <zip destfile="${target.dir}/upgrade-dcm4chee-auditlog-${db.name}-${audit-version}.zip">
      <zipfileset dir="${dcm4chee-audit.login}/src/main/config/${db.name}" prefix="${dist.db.config}">
        <include name="conf/login-config.xml"/>
      </zipfileset>
      <zipfileset dir="${dcm4chee-audit.login}/target" prefix="${dist.db.config}/lib">
        <include name="*.jar"/>
      </zipfileset>
        <zipfileset dir="${dcm4chee-audit.logger}/src/main/config" prefix="${dist.db.config}/conf">
          <include name="dcm4chee-audit-attribute-change.xml"/>
        </zipfileset>
      <zipfileset dir="${dcm4chee-audit.logger}/target" prefix="${dist.db.config}/deploy">
        <include name="*.sar"/>
      </zipfileset>
      <zipfileset dir="${target.dir}" filemode="755">
    	<include name="bin/uninstall-dcm4chee-auditlog-old.sh"/>
      </zipfileset>
      <zipfileset dir="${target.dir}">
      	<include name="bin/uninstall-dcm4chee-auditlog-old.bat"/>
      </zipfileset>
    </zip>  	     
  </target>	
</project>