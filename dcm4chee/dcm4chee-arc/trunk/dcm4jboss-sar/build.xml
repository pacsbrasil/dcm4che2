<project name="dcm4jboss-sar" default="jar">
	<property file="build.properties"/>
	<property name="javac.debug" value="on"/>
	<property name="version" value="0.2.0"/>

	<property name="dist.db2" value="dcm4jboss-db2-${version}"/>
	<property name="dist.psql" value="dcm4jboss-psql-${version}"/>

	<property name="src.dir" value="${basedir}/src"/>
	<property name="src.java" value="${src.dir}/java"/>
	<property name="src.etc" value="${src.dir}/etc"/>
	<property name="src.res" value="${src.dir}/resources"/>

	<property name="target.dir" value="${basedir}/target"/>
	<property name="target.classes" value="${target.dir}/classes"/>
	<property name="target.xdoclet" value="${target.dir}/xdoclet"/>
	<property name="target.java" value="${target.xdoclet}/java"/>
	<property name="target.deploy" value="${target.dir}/deploy"/>
	<property name="target.lib" value="${target.dir}/lib"/>

    <!-- Override with your dcm4che dist location -->
	<property name="dcm4che.home" value="${user.home}/work/dcm4che14/build"/>		
	<property name="dcm4che.jar" value="${dcm4che.home}/lib/dcm4che.jar"/>		

    <!-- Override with your dcm4jboss-ejb dist location -->
	<property name="dcm4jboss-ejb.home" value="${user.home}/work/dcm4jboss-ejb/target"/>		

    <!-- Override with your JBoss/Web server bundle dist location -->
	<property name="jboss.home" value="${user.home}/jboss-3.2.2"/>		
	<property name="jboss.conf" value="${jboss.home}/server/pacs"/>		
	<property name="jboss.deploy" value="${jboss.conf}/deploy"/>		

	<path id="base.path">
		<pathelement location="${dcm4che.jar}"/>
		<pathelement location="${dcm4jboss-ejb.home}/lib/dcm4jboss-jdbc.jar"/>
		<pathelement location="${dcm4jboss-ejb.home}/deploy/dcm4jboss-ejb-psql.jar"/>
		<fileset dir="${jboss.home}/lib">
			<include name="*.jar"/>
		</fileset>
		<fileset dir="${jboss.conf}/lib">
			<include name="*.jar"/>
		</fileset>
	</path>

    <!-- Override with your XDoclet bundle dist location -->
	<property name="xdoclet.home" value="${user.home}/xdoclet"/>
	<path id="xdoclet.path">
		<fileset dir="${xdoclet.home}/lib">
			<include name="*.jar"/>
		</fileset>
		<path refid="base.path"/>
	</path>

   	<!-- =================================================================== -->
    <!-- Initialize                                                          -->
    <!-- =================================================================== -->
    
    <target name="init">
    	<tstamp>
            <format property="TODAY" pattern="dd.MM.yyyy"/>
        </tstamp>
        <taskdef
            name="xdoclet"
            classname="xdoclet.DocletTask"
            classpathref="xdoclet.path"
            />
        <taskdef
            name="jmxdoclet"
            classname="xdoclet.modules.jmx.JMXDocletTask"
            classpathref="xdoclet.path"
            />
    </target>

    <!-- =================================================================== -->
    <!-- Prepares the directory structure                                    -->
    <!-- =================================================================== -->
    <target name="prepare" depends="init">
        <mkdir dir="${target.classes}"/>
        <mkdir dir="${target.java}"/>
        <mkdir dir="${target.lib}"/>
        <mkdir dir="${target.deploy}"/>
        <mkdir dir="${target.dir}/${dist.db2}"/>
        <mkdir dir="${target.dir}/${dist.psql}"/>
   </target>

    <!-- =================================================================== -->
    <!-- Invoke XDoclet's jmxdoclet                                          -->
    <!-- =================================================================== -->
    <target name="jmxdoclet" depends="prepare" unless="xdoclet.skip">

        <jmxdoclet 
            destdir="${target.java}"
            excludedtags="@version,@author,@todo,@since"
            addedtags="@xdoclet-generated at ${TODAY},@copyright The XDoclet Team,@author XDoclet,@version ${version}"
            force="${xdoclet.force}"
            verbose="false"
            >

            <fileset dir="${src.java}">
                <include name="**/*Service.java"/>
            </fileset>
            
            <mbeaninterface/>
		</jmxdoclet>
		
	</target>

   	<!-- =================================================================== -->
   	<!-- Compiles the source code                                            -->
   	<!-- =================================================================== -->   
   	<target name="compile" depends="jmxdoclet">
		<javac
        	destdir="${target.classes}"
			debug="${javac.debug}"
         	deprecation="off"
         	optimize="on"
         	classpathref="base.path"
      	>
        	<src path="${target.java}"/>
         	<src path="${src.java}"/>
      	</javac>
   	</target>

   	<!-- =================================================================== -->
   	<!-- build sar                                        -->
   	<!-- =================================================================== -->
   
   	<target name="sar" depends="compile">
        <zip zipfile="${target.deploy}/dcm4jboss.sar">
        	<zipfileset dir="${target.classes}"/>
        	<zipfileset dir="${src.res}/dcm4jboss-sar">
        		<include name="META-INF/jboss-service.xml"/>
        	</zipfileset>        	
        </zip>
    </target>

   	<!-- =================================================================== -->
   	<!-- build jar                                        -->
   	<!-- =================================================================== -->
   
   	<target name="jar" depends="compile">
        <jar jarfile="${target.lib}/dcm4jboss.jar">
        	<manifest>
        		<attribute name="Class-Path" value="dcm4che.jar dcm4jboss-ejb-client.jar dcm4jboss-jdbc.jar"/>
        	</manifest>
        	<fileset dir="${target.classes}"/>
        </jar>
    </target>

   	<!-- =================================================================== -->
   	<!-- deploy sars                                                         -->
   	<!-- =================================================================== -->
   
   	<target name="deploy" depends="sar">
    	<copy file="${target.deploy}/dcm4jboss.sar" todir="${jboss.conf}/deploy"/>
   	</target>

   	<!-- =================================================================== -->
   	<!-- undeploy sars                                                       -->
   	<!-- =================================================================== -->
   
   	<target name="undeploy">
    	<delete file="${jboss.conf}/deploy/dcm4jboss.sar"/>
   	</target>

 
    <!-- =================================================================== -->
   	<!-- Pack distributions                                                  -->
   	<!-- =================================================================== -->
   
   	<target name="dist" depends="dist-psql,dist-db2"/>
   	<target name="dist-psql" depends="jar">
   		<copy todir="${target.dir}/${dist.psql}">
   			<fileset dir="${dcm4che.home}">
   				<include name="lib/dcm4che.jar"/>
   			</fileset>
   			<fileset dir="${dcm4jboss-ejb.home}">
   				<include name="lib/dcm4jboss-ejb-client.jar"/>
   				<include name="lib/dcm4jboss-jdbc.jar"/>
   				<include name="deploy/dcm4jboss-ejb-psql.jar"/>
   			</fileset>
   			<fileset dir="${src.etc}">
   				<include name="deploy/*.xml"/>
   			</fileset>
   			<fileset dir="${target.dir}">
   				<include name="lib/dcm4jboss.jar"/>
   			</fileset>
   		</copy>
   		<zip
   			destfile="${target.dir}/${dist.psql}.zip"
   			basedir="${target.dir}"
   			includes="${dist.psql}/**"
   		/>
   	</target>
   	<target name="service-db2-xml" >
   		<copy todir="${target.dir}">
   			<fileset dir="${src.etc}">
   				<include name="deploy/*.xml"/>
   			</fileset>
   		</copy>
   		<replace
   			dir="${target.deploy}"
   			includes="*.xml"
   			token="PostgresDS"
   			value="DB2DS"
   		/>
   	</target>
   	<target name="dist-db2" depends="jar,service-db2-xml">
   		<copy todir="${target.dir}/${dist.db2}">
   			<fileset dir="${dcm4che.home}">
   				<include name="lib/dcm4che.jar"/>
   			</fileset>
   			<fileset dir="${dcm4jboss-ejb.home}">
   				<include name="lib/dcm4jboss-ejb-client.jar"/>
   				<include name="lib/dcm4jboss-jdbc.jar"/>
   				<include name="deploy/dcm4jboss-ejb-db2.jar"/>
   			</fileset>
   			<fileset dir="${target.dir}">
   				<include name="lib/dcm4jboss.jar"/>
   				<include name="deploy/*.xml"/>
   			</fileset>
   		</copy>
   		<zip
   			destfile="${target.dir}/${dist.db2}.zip"
   			basedir="${target.dir}"
   			includes="${dist.db2}/**"
   		/>
   	</target>
	
    
   	<!-- =================================================================== -->
   	<!-- Cleans up the current build                                         -->
   	<!-- =================================================================== -->
   
   	<target name="clean">
     	<delete dir="${target.dir}"/>
   	</target>
	
    
</project>