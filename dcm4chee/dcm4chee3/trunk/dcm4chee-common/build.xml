<?xml version="1.0"?>

<project name="dcm4chee3-common" default="jar">
    <!-- Allow user to adjust build properties without
        modifying this build script.
        -->
    <property file="build.properties" />
    <property file="../build.properties" />

    <property name="version" value="3.0.0-alpha" />

    <!-- Java properties -->
    <property name="javac.compiler" value="modern" />
    <property name="javac.debug" value="on" />
    <property name="javac.nowarn" value="off" />
    <property name="javac.source" value="1.5" />
    <property name="javac.target" value="1.5" />

    <!-- Override with your dcm4che14 dist location -->
    <property name="dcm4che.home" value="../../../dcm4jboss-all/dcm4che14/build" />
    <property name="dcm4che.jar" value="${dcm4che.home}/lib/dcm4che.jar" />

    <!-- Override with your JBoss server bundle dist location -->
    <property name="jboss.home" value="${user.home}/jboss-4.2.0.GA" />
    <property name="jboss.lib" value="${jboss.home}/lib" />
    <property name="jboss.server.lib" value="${jboss.home}/server/default/lib" />
    <property name="jboss.ejb3.lib" value="${jboss.home}/server/default/deploy/ejb3.deployer" />

    <!-- Input properties -->
    <property name="lib.dir" value="${basedir}/lib" />
    <property name="src.dir" value="${basedir}/src/main" />
    <property name="src.java" value="${src.dir}/java" />
    <property name="src.res" value="${src.dir}/resources" />

    <!-- Output properties -->
    <property name="target" value="${basedir}/target" />
    <property name="target.classes" value="${target}/classes" />
    <property name="target.lib" value="${target}/lib" />
    <property name="build.javadocs.dir" value="${target}/doc/api"/>

    <path id="class.path">
        <pathelement location="${dcm4che.jar}" />
        <pathelement location="${lib.dir}/spring.jar" />
        <fileset dir="${jboss.lib}">
            <include name="*.jar" />
        </fileset>
        <fileset dir="${jboss.server.lib}">
            <include name="*.jar" />
        </fileset>
        <fileset dir="${jboss.ejb3.lib}">
            <include name="*.jar" />
        </fileset>
    </path>

    <!-- display usage info -->
    <target name="usage">
        <echo>

        These are the targets supported by this Ant build script:
            usage      ---> Print this message   
            init       ---> Compile package, create jar, artifacts
            compile    ---> Compile all of the Java source code.
            jar        ---> Package the compiled classes and persistence.xml into a JAR.
            jar-noxml  ---> Package the compiled classes into a JAR without the persistence.xml file.
            clean      ---> Deletes compiled classes from previous runs.
            doc        ---> Generate javadoc API documentation.

        </echo>
    </target>

    <target name="init">
        <tstamp>
            <format property="TODAY" pattern="yyyy-MM-dd" />
        </tstamp>
    </target>

    <target name="compile" depends="init">
        <mkdir dir="${target.classes}" />
        <javac destdir="${target.classes}" debug="${javac.debug}" 
                deprecation="off" optimize="on" classpathref="class.path" 
                compiler="${javac.compiler}" nowarn="${javac.nowarn}" 
                source="${javac.source}" target="${javac.target}">
            <src path="${src.java}" />
            <include name="org/dcm4che/**" />
        </javac>
    </target>

    <target name="jar" depends="compile">
        <mkdir dir="${target.lib}" />
        <antcall target="copy-xml" />
        <jar jarfile="${target.lib}/dcm4chee-common.jar">
            <manifest>
                <attribute name="Class-Path" value="dcm4che.jar" />
                <attribute name="Implementation-Title" value="dcm4chee-common" />
                <attribute name="Implementation-Version" value="${version} ${TODAY}" />
                <attribute name="Implementation-Vendor" value="dcm4che.org" />
            </manifest>
            <fileset dir="${target.classes}" />
        </jar>
    </target>
    
    <target name="jar-noxml">
        <property name="noxml" value="true"/>
        <antcall target="jar" />
    </target>
    
    <target name="copy-xml" unless="noxml">
        <copy todir="${target.classes}/META-INF">
            <fileset dir="${src.res}/META-INF">
                <include name="persistence.xml"/>
            </fileset>
        </copy>
    </target>

    <target name="clean">
        <delete dir="${target}" />
    </target>

    <target name="check-javadoc">
        <uptodate property="uptodate-javadoc" targetfile="${build.javadocs.dir}/index.html">
            <srcfiles dir="${src.java}" includes="org/dcm4che/**/*.java" />
        </uptodate>
    </target>

    <target name="doc" depends="check-javadoc" unless="uptodate-javadoc" description="Generate javadoc for dcm4chee3-common API">
        <mkdir dir="${build.javadocs.dir}" />
        <javadoc destdir="${build.javadocs.dir}" sourcepath="${src.java}" classpathref="class.path">
            <package name="org.dcm4che.*" />
        </javadoc>
    </target>

</project>